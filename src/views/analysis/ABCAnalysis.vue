<template>
  <div class="abc-analysis">
    <h2>ABCåˆ†ç±»åˆ†æ</h2>
    
    <!-- åˆ†ç±»ç»Ÿè®¡ -->
    <el-row :gutter="16" class="stat-row">
      <el-col :xs="24" :sm="8">
        <el-card shadow="never" class="stat-card class-a">
          <div class="class-header">
            <span class="class-tag">Aç±»</span>
            <span class="class-desc">é‡ç‚¹ç®¡æ§</span>
          </div>
          <div class="class-stats">
            <div class="stat-item">
              <span class="stat-value">{{ classStats.a.count }}</span>
              <span class="stat-unit">SKU ({{ classStats.a.skuPercent }}%)</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">Â¥{{ (classStats.a.value / 10000).toFixed(1) }}ä¸‡</span>
              <span class="stat-unit">é‡‘é¢ ({{ classStats.a.valuePercent }}%)</span>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :xs="24" :sm="8">
        <el-card shadow="never" class="stat-card class-b">
          <div class="class-header">
            <span class="class-tag">Bç±»</span>
            <span class="class-desc">å¸¸è§„ç®¡ç†</span>
          </div>
          <div class="class-stats">
            <div class="stat-item">
              <span class="stat-value">{{ classStats.b.count }}</span>
              <span class="stat-unit">SKU ({{ classStats.b.skuPercent }}%)</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">Â¥{{ (classStats.b.value / 10000).toFixed(1) }}ä¸‡</span>
              <span class="stat-unit">é‡‘é¢ ({{ classStats.b.valuePercent }}%)</span>
            </div>
          </div>
        </el-card>
      </el-col>
      <el-col :xs="24" :sm="8">
        <el-card shadow="never" class="stat-card class-c">
          <div class="class-header">
            <span class="class-tag">Cç±»</span>
            <span class="class-desc">ç®€åŒ–ç®¡ç†</span>
          </div>
          <div class="class-stats">
            <div class="stat-item">
              <span class="stat-value">{{ classStats.c.count }}</span>
              <span class="stat-unit">SKU ({{ classStats.c.skuPercent }}%)</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">Â¥{{ (classStats.c.value / 10000).toFixed(1) }}ä¸‡</span>
              <span class="stat-unit">é‡‘é¢ ({{ classStats.c.valuePercent }}%)</span>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <el-row :gutter="16">
      <!-- ABCåˆ†å¸ƒå›¾ -->
      <el-col :xs="24" :md="12">
        <el-card shadow="never">
          <template #header><span>ABCåˆ†ç±»åˆ†å¸ƒ</span></template>
          <div class="pie-chart">
            <div class="pie-ring">
              <div class="ring-a" :style="{'--a-deg': classStats.a.valuePercent * 3.6 + 'deg'}"></div>
              <div class="ring-b" :style="{'--b-start': classStats.a.valuePercent * 3.6 + 'deg', '--b-deg': classStats.b.valuePercent * 3.6 + 'deg'}"></div>
              <div class="ring-center">
                <div class="center-value">Â¥{{ (totalValue / 10000).toFixed(0) }}ä¸‡</div>
                <div class="center-label">åº“å­˜æ€»é¢</div>
              </div>
            </div>
            <div class="pie-legend">
              <div class="legend-item"><span class="dot a"></span>Aç±» {{ classStats.a.valuePercent }}%</div>
              <div class="legend-item"><span class="dot b"></span>Bç±» {{ classStats.b.valuePercent }}%</div>
              <div class="legend-item"><span class="dot c"></span>Cç±» {{ classStats.c.valuePercent }}%</div>
            </div>
          </div>
        </el-card>
      </el-col>
      
      <!-- ç®¡ç†ç­–ç•¥ -->
      <el-col :xs="24" :md="12">
        <el-card shadow="never">
          <template #header><span>åˆ†ç±»ç®¡ç†ç­–ç•¥</span></template>
          <div class="strategy-list">
            <div class="strategy-item a">
              <div class="strategy-header">
                <el-tag type="danger" effect="dark">Aç±»ç‰©æ–™</el-tag>
                <span class="strategy-rule">é‡‘é¢å 70-80%ï¼ŒSKUå 10-20%</span>
              </div>
              <ul class="strategy-points">
                <li>é‡ç‚¹ç›‘æ§ï¼Œç²¾ç¡®é¢„æµ‹éœ€æ±‚</li>
                <li>ç¼©çŸ­é‡‡è´­å‘¨æœŸï¼Œé™ä½åº“å­˜</li>
                <li>é¢‘ç¹ç›˜ç‚¹ï¼ˆæ¯å‘¨/æ¯æœˆï¼‰</li>
                <li>ä¸ä¾›åº”å•†å»ºç«‹æˆ˜ç•¥åˆä½œ</li>
              </ul>
            </div>
            <div class="strategy-item b">
              <div class="strategy-header">
                <el-tag type="warning" effect="dark">Bç±»ç‰©æ–™</el-tag>
                <span class="strategy-rule">é‡‘é¢å 15-20%ï¼ŒSKUå 20-30%</span>
              </div>
              <ul class="strategy-points">
                <li>å¸¸è§„ç®¡ç†ï¼Œé€‚ä¸­åº“å­˜</li>
                <li>å®šæœŸå®¡æ ¸é‡‡è´­ç­–ç•¥</li>
                <li>å­£åº¦ç›˜ç‚¹</li>
              </ul>
            </div>
            <div class="strategy-item c">
              <div class="strategy-header">
                <el-tag type="info" effect="dark">Cç±»ç‰©æ–™</el-tag>
                <span class="strategy-rule">é‡‘é¢å 5-10%ï¼ŒSKUå 50-70%</span>
              </div>
              <ul class="strategy-points">
                <li>ç®€åŒ–ç®¡ç†ï¼Œæ‰¹é‡é‡‡è´­</li>
                <li>é€‚å½“å¢åŠ å®‰å…¨åº“å­˜</li>
                <li>å¹´åº¦ç›˜ç‚¹å³å¯</li>
              </ul>
            </div>
          </div>
        </el-card>
      </el-col>
    </el-row>

    <!-- ç‰©æ–™æ˜ç»† -->
    <el-card shadow="never" style="margin-top:16px">
      <template #header>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span>ç‰©æ–™ABCåˆ†ç±»æ˜ç»†</span>
          <div>
            <el-radio-group v-model="filterClass" size="small" style="margin-right:12px">
              <el-radio-button label="">å…¨éƒ¨</el-radio-button>
              <el-radio-button label="A">Aç±»</el-radio-button>
              <el-radio-button label="B">Bç±»</el-radio-button>
              <el-radio-button label="C">Cç±»</el-radio-button>
            </el-radio-group>
            <el-button type="success" @click="handleExport">å¯¼å‡º</el-button>
          </div>
        </div>
      </template>
      <el-table :data="filteredData" border stripe max-height="400">
        <el-table-column type="index" label="#" width="50" />
        <el-table-column prop="materialCode" label="ç‰©æ–™ç¼–ç " width="130" sortable />
        <el-table-column prop="materialName" label="ç‰©æ–™åç§°" min-width="150" show-overflow-tooltip />
        <el-table-column prop="category" label="ç‰©æ–™åˆ†ç±»" width="100" />
        <el-table-column prop="annualUsage" label="å¹´æ¶ˆè€—é‡" width="100" align="right" sortable />
        <el-table-column prop="price" label="å•ä»·" width="90" align="right">
          <template #default="{row}">Â¥{{ row.price.toFixed(2) }}</template>
        </el-table-column>
        <el-table-column prop="annualValue" label="å¹´æ¶ˆè€—é‡‘é¢" width="120" align="right" sortable>
          <template #default="{row}">Â¥{{ row.annualValue.toLocaleString() }}</template>
        </el-table-column>
        <el-table-column prop="cumulativePercent" label="ç´¯è®¡å æ¯”" width="100" align="right">
          <template #default="{row}">{{ row.cumulativePercent.toFixed(1) }}%</template>
        </el-table-column>
        <el-table-column prop="abcClass" label="ABCåˆ†ç±»" width="90" align="center">
          <template #default="{row}">
            <el-tag :type="getClassType(row.abcClass)" effect="dark" size="small">{{ row.abcClass }}ç±»</el-tag>
          </template>
        </el-table-column>
        <el-table-column label="ç®¡ç†å»ºè®®" min-width="140">
          <template #default="{row}">
            <span class="suggest-text">{{ getClassSuggestion(row.abcClass) }}</span>
          </template>
        </el-table-column>
      </el-table>
    </el-card>

    <!-- åˆ†ç±»è¯´æ˜ -->
    <el-card shadow="never" style="margin-top:16px">
      <template #header><span>ğŸ“Š ABCåˆ†ç±»è®¡ç®—è¯´æ˜</span></template>
      <div class="calc-steps">
        <div class="step">
          <div class="step-num">1</div>
          <div class="step-content">
            <div class="step-title">è®¡ç®—å¹´æ¶ˆè€—é‡‘é¢</div>
            <div class="step-desc">å¹´æ¶ˆè€—é‡‘é¢ = å¹´æ¶ˆè€—é‡ Ã— å•ä»·</div>
          </div>
        </div>
        <div class="step">
          <div class="step-num">2</div>
          <div class="step-content">
            <div class="step-title">æŒ‰é‡‘é¢é™åºæ’åˆ—</div>
            <div class="step-desc">å°†æ‰€æœ‰ç‰©æ–™æŒ‰å¹´æ¶ˆè€—é‡‘é¢ä»é«˜åˆ°ä½æ’åº</div>
          </div>
        </div>
        <div class="step">
          <div class="step-num">3</div>
          <div class="step-content">
            <div class="step-title">è®¡ç®—ç´¯è®¡å æ¯”</div>
            <div class="step-desc">é€é¡¹ç´¯åŠ é‡‘é¢ï¼Œè®¡ç®—å æ€»é‡‘é¢çš„ç™¾åˆ†æ¯”</div>
          </div>
        </div>
        <div class="step">
          <div class="step-num">4</div>
          <div class="step-content">
            <div class="step-title">åˆ’åˆ†ABCç±»åˆ«</div>
            <div class="step-desc">ç´¯è®¡â‰¤80%ä¸ºAç±»ï¼Œâ‰¤95%ä¸ºBç±»ï¼Œå…¶ä½™ä¸ºCç±»</div>
          </div>
        </div>
      </div>
    </el-card>
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { ElMessage } from 'element-plus'

const filterClass = ref('')
const allData = ref([])

const totalValue = computed(() => allData.value.reduce((s, d) => s + d.annualValue, 0))

const classStats = computed(() => {
  const data = allData.value
  const total = data.length || 1
  const totalVal = totalValue.value || 1
  const aItems = data.filter(d => d.abcClass === 'A')
  const bItems = data.filter(d => d.abcClass === 'B')
  const cItems = data.filter(d => d.abcClass === 'C')
  return {
    a: { count: aItems.length, skuPercent: Math.round(aItems.length / total * 100), value: aItems.reduce((s, d) => s + d.annualValue, 0), valuePercent: Math.round(aItems.reduce((s, d) => s + d.annualValue, 0) / totalVal * 100) },
    b: { count: bItems.length, skuPercent: Math.round(bItems.length / total * 100), value: bItems.reduce((s, d) => s + d.annualValue, 0), valuePercent: Math.round(bItems.reduce((s, d) => s + d.annualValue, 0) / totalVal * 100) },
    c: { count: cItems.length, skuPercent: Math.round(cItems.length / total * 100), value: cItems.reduce((s, d) => s + d.annualValue, 0), valuePercent: Math.round(cItems.reduce((s, d) => s + d.annualValue, 0) / totalVal * 100) }
  }
})

const filteredData = computed(() => {
  if (!filterClass.value) return allData.value
  return allData.value.filter(d => d.abcClass === filterClass.value)
})

const getClassType = c => ({ A: 'danger', B: 'warning', C: 'info' }[c] || 'info')
const getClassSuggestion = c => ({ A: 'é‡ç‚¹ç®¡æ§ï¼Œç²¾ç¡®é¢„æµ‹', B: 'å¸¸è§„ç®¡ç†ï¼Œå®šæœŸå®¡æ ¸', C: 'ç®€åŒ–ç®¡ç†ï¼Œæ‰¹é‡é‡‡è´­' }[c] || '')

const handleExport = () => {
  const csv = [['ç‰©æ–™ç¼–ç ', 'ç‰©æ–™åç§°', 'åˆ†ç±»', 'å¹´æ¶ˆè€—é‡', 'å•ä»·', 'å¹´æ¶ˆè€—é‡‘é¢', 'ç´¯è®¡å æ¯”', 'ABCåˆ†ç±»'].join(','),
    ...filteredData.value.map(r => [r.materialCode, r.materialName, r.category, r.annualUsage, r.price, r.annualValue, r.cumulativePercent.toFixed(1) + '%', r.abcClass + 'ç±»'].join(','))
  ].join('\n')
  const blob = new Blob(['\ufeff' + csv], { type: 'text/csv' })
  const link = document.createElement('a')
  link.href = URL.createObjectURL(blob)
  link.download = `ABCåˆ†ç±»åˆ†æ_${new Date().toISOString().slice(0, 10)}.csv`
  link.click()
  ElMessage.success('å¯¼å‡ºæˆåŠŸ')
}

onMounted(() => {
  const categories = ['MROå¤‡ä»¶', 'åŸææ–™', 'åŒ…è£…ææ–™', 'åŠå…¬ç”¨å“', 'è®¾å¤‡é…ä»¶']
  // ç”Ÿæˆæ•°æ®å¹¶æ’åº
  let data = Array(100).fill(null).map((_, i) => {
    const price = Math.floor(Math.random() * 500) + 50
    const annualUsage = Math.floor(Math.random() * 1000) + 100
    return {
      id: i + 1,
      materialCode: `MAT${String(i + 1).padStart(6, '0')}`,
      materialName: `ç‰©æ–™åç§°${i + 1}`,
      category: categories[i % 5],
      price,
      annualUsage,
      annualValue: price * annualUsage
    }
  })
  // æŒ‰é‡‘é¢é™åºæ’åº
  data.sort((a, b) => b.annualValue - a.annualValue)
  // è®¡ç®—ç´¯è®¡å æ¯”å’ŒABCåˆ†ç±»
  const total = data.reduce((s, d) => s + d.annualValue, 0)
  let cumulative = 0
  data.forEach(item => {
    cumulative += item.annualValue
    item.cumulativePercent = cumulative / total * 100
    item.abcClass = item.cumulativePercent <= 80 ? 'A' : item.cumulativePercent <= 95 ? 'B' : 'C'
  })
  allData.value = data
})
</script>

<style scoped>
.abc-analysis { padding: 16px; background: #f5f7fa; min-height: calc(100vh - 120px); }
.stat-row { margin-bottom: 16px; }
.stat-card { color: white; }
.stat-card.class-a { background: linear-gradient(135deg, #f56c6c, #f89898); }
.stat-card.class-b { background: linear-gradient(135deg, #e6a23c, #ebb563); }
.stat-card.class-c { background: linear-gradient(135deg, #909399, #a6a9ad); }
.class-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
.class-tag { font-size: 24px; font-weight: bold; }
.class-desc { font-size: 13px; opacity: 0.9; }
.class-stats { display: flex; justify-content: space-around; }
.stat-item { text-align: center; }
.stat-item .stat-value { display: block; font-size: 20px; font-weight: bold; }
.stat-item .stat-unit { font-size: 12px; opacity: 0.8; }

.pie-chart { display: flex; align-items: center; padding: 20px; }
.pie-ring { position: relative; width: 160px; height: 160px; border-radius: 50%; background: conic-gradient(#f56c6c 0deg var(--a-deg, 288deg), #e6a23c var(--a-deg, 288deg) calc(var(--a-deg, 288deg) + var(--b-deg, 54deg)), #909399 calc(var(--a-deg, 288deg) + var(--b-deg, 54deg)) 360deg); margin-right: 30px; }
.ring-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; background: white; border-radius: 50%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.center-value { font-size: 18px; font-weight: bold; color: #303133; }
.center-label { font-size: 12px; color: #909399; }
.pie-legend { flex: 1; }
.legend-item { margin: 12px 0; font-size: 14px; display: flex; align-items: center; }
.dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
.dot.a { background: #f56c6c; }
.dot.b { background: #e6a23c; }
.dot.c { background: #909399; }

.strategy-list { }
.strategy-item { margin-bottom: 16px; padding: 12px; border-radius: 8px; }
.strategy-item.a { background: #fef0f0; }
.strategy-item.b { background: #fdf6ec; }
.strategy-item.c { background: #f4f4f5; }
.strategy-header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
.strategy-rule { font-size: 12px; color: #909399; }
.strategy-points { margin: 0; padding-left: 20px; font-size: 13px; color: #606266; }
.strategy-points li { margin: 4px 0; }

.calc-steps { display: flex; gap: 20px; flex-wrap: wrap; }
.step { display: flex; align-items: flex-start; gap: 12px; flex: 1; min-width: 200px; }
.step-num { width: 32px; height: 32px; background: #409eff; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; flex-shrink: 0; }
.step-title { font-weight: bold; color: #303133; margin-bottom: 4px; }
.step-desc { font-size: 13px; color: #909399; }
.suggest-text { font-size: 12px; color: #909399; }
</style>
